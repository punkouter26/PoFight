import{u as e}from"./store-BIbf0-nf.js";const t=new class{lastFrameTime=0;accumulatedTime=0;timeStep=1e3/60;requestID=null;isRunning=!1;updateCallback=null;constructor(){}setUpdateCallback(e){this.updateCallback=e}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.accumulatedTime=0,this.requestID=requestAnimationFrame(this.loop))}stop(){this.isRunning=!1,null!==this.requestID&&(cancelAnimationFrame(this.requestID),this.requestID=null)}loop=e=>{if(!this.isRunning)return;let t=e-this.lastFrameTime;for(this.lastFrameTime=e,t>1e3&&(t=1e3),this.accumulatedTime+=t;this.accumulatedTime>=this.timeStep;)this.updateCallback&&this.updateCallback(this.timeStep/1e3),this.accumulatedTime-=this.timeStep;this.requestID=requestAnimationFrame(this.loop)}};class s{_value;subscribers=new Set;constructor(e){this._value=e}get value(){return this._value}peek(){return this._value}set value(e){this._value!==e&&(this._value=e,this.notify())}subscribe(e){return this.subscribers.add(e),()=>{this.subscribers.delete(e)}}notify(){this.subscribers.forEach(e=>e(this._value))}}function a(e){return new s(e)}const i=1920,h=1080,r=100,n=200,l={damage:5},u={damage:20},c={damage:7},o={damage:25};class d{id;x;y;state;health;chargeLevel;attackType;attackHeight;facingRight=!0;chargeStartTime=0;constructor(e,t){this.id=e,this.x=a(t),this.y=a(900),this.state=a("IDLE"),this.health=a(100),this.chargeLevel=a(0),this.attackType=a("NONE"),this.attackHeight=a("MID")}update(e,t){const s=this.state.value;["IDLE","MOVING","BLOCKING_HIGH","BLOCKING_LOW"].includes(s)&&(t.y>.5?this.state.value="BLOCKING_HIGH":t.y<-.5?this.state.value="BLOCKING_LOW":"BLOCKING_HIGH"!==s&&"BLOCKING_LOW"!==s||(this.state.value="IDLE"));const a="BLOCKING_HIGH"===this.state.value||"BLOCKING_LOW"===this.state.value;if(["IDLE","MOVING"].includes(s)&&!a&&(0!==t.x?(this.state.value="MOVING",this.x.value+=400*t.x*e,this.facingRight=t.x>0):"MOVING"===s&&(this.state.value="IDLE")),t.punchHeld||t.kickHeld){if(["CHARGING","OVERHEATED","ATTACKING"].includes(s)||a||(this.state.value="CHARGING",this.chargeStartTime=performance.now()/1e3,this.chargeLevel.value=0,this.attackType.value=t.punchHeld?"PUNCH":"KICK"),"CHARGING"===s){const e=performance.now()/1e3-this.chargeStartTime;this.chargeLevel.value=Math.min(e/1,1),e>2&&(this.state.value="OVERHEATED",this.chargeLevel.value=0,setTimeout(()=>{"OVERHEATED"===this.state.value&&(this.state.value="IDLE")},1e3))}}else if("CHARGING"===s){const e=performance.now()/1e3-this.chargeStartTime;let s="MID";t.y>.5&&(s="HIGH"),t.y<-.5&&(s="LOW"),this.attackHeight.value=s,this.executeAttack(e),this.chargeLevel.value=0}}executeAttack(e){this.state.value="ATTACKING";setTimeout(()=>{"ATTACKING"===this.state.value&&(this.state.value="IDLE")},300)}}class p{me;opponent;mistakeRate;aggression;nextActionTime=0;constructor(e,t,s){this.me=e,this.opponent=t,this.mistakeRate=Math.max(0,.5-.1*s),this.aggression=.2*s}update(e,t){this.nextActionTime}getInput(){const e=Math.abs(this.me.x.value-this.opponent.x.value),t={x:0,y:0,punchHeld:!1,kickHeld:!1};if(("ATTACKING"===this.opponent.state.value||this.opponent.chargeLevel.value>.5)&&Math.random()>this.mistakeRate){const e=Math.random()>.5;return t.y=e?1:-1,t}return e>150?t.x=this.me.x.value<this.opponent.x.value?1:-1:Math.random()<.1*this.aggression&&(t.punchHeld=!0),t}}const v={w:"UP",a:"LEFT",s:"DOWN",d:"RIGHT",r:"PUNCH",f:"KICK",arrowup:"UP",arrowdown:"DOWN",arrowleft:"LEFT",arrowright:"RIGHT"};const m=new class{keyStates={UP:{isPressed:!1,pressedAt:0},DOWN:{isPressed:!1,pressedAt:0},LEFT:{isPressed:!1,pressedAt:0},RIGHT:{isPressed:!1,pressedAt:0},PUNCH:{isPressed:!1,pressedAt:0},KICK:{isPressed:!1,pressedAt:0}};constructor(){"undefined"!=typeof window&&(window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp))}cleanup(){"undefined"!=typeof window&&(window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp))}handleKeyDown=e=>{const t=e.key.toLowerCase(),s=v[t];s&&!this.keyStates[s].isPressed&&(this.keyStates[s].isPressed=!0,this.keyStates[s].pressedAt=performance.now()/1e3)};handleKeyUp=e=>{const t=e.key.toLowerCase(),s=v[t];s&&(this.keyStates[s].isPressed=!1,this.keyStates[s].pressedAt=0)};isPressed(e){return this.keyStates[e].isPressed}getHoldDuration(e){return this.keyStates[e].isPressed?performance.now()/1e3-this.keyStates[e].pressedAt:0}getAxis(){let e=0,t=0;return this.isPressed("RIGHT")&&(e+=1),this.isPressed("LEFT")&&(e-=1),this.isPressed("UP")&&(t+=1),this.isPressed("DOWN")&&(t-=1),{x:e,y:t}}};class I{player;cpu;ai;gameLoop;constructor(t){this.gameLoop=t;const s=e.getState().currentLevel;this.player=new d("player",400),this.cpu=new d("cpu",1200),this.player.facingRight=!0,this.cpu.facingRight=!1,this.ai=new p(this.cpu,this.player,s),t.setUpdateCallback(this.update.bind(this))}update(e){const t={x:m.getAxis().x,y:m.getAxis().y,punchHeld:m.isPressed("PUNCH"),kickHeld:m.isPressed("KICK")},s=this.ai.getInput();this.player.update(e,t),this.cpu.update(e,s),function(e,t){const s=e.x.value,a=t.x.value;return Math.abs(s-a)<100}(this.player,this.cpu)&&function(e,t){const s=t.x.value-e.x.value;if(Math.abs(s)<80){const a=(80-Math.abs(s))/2;s>0?(e.x.value-=a,t.x.value+=a):(e.x.value+=a,t.x.value-=a)}}(this.player,this.cpu),this.checkHits(),this.cpu.health.value<=0?this.handleWin():this.player.health.value<=0&&this.handleLoss()}checkHits(){this.checkHitForAttacker(this.player,this.cpu),this.checkHitForAttacker(this.cpu,this.player)}checkHitForAttacker(e,t){if("ATTACKING"!==e.state.value)return;if(Math.abs(e.x.value-t.x.value)>150)return;const s=e.attackHeight.value,a=t.state.value;if("BLOCKING_HIGH"===a&&"HIGH"===s||"BLOCKING_LOW"===a&&"LOW"===s)return;if(("BLOCKING_HIGH"===a||"BLOCKING_LOW"===a)&&"MID"===s){const e=2;return void(t.health.value=Math.max(0,t.health.value-e))}const i=e.attackType.value,h=e.chargeLevel.peek();let r=0;"PUNCH"===i?r=h>=.9?u.damage:l.damage:"KICK"===i&&(r=h>=.9?o.damage:c.damage),t.health.value=Math.max(0,t.health.value-r),t.state.value="STUNNED",e.state.value="IDLE",e.attackType.value="NONE",setTimeout(()=>{"STUNNED"===t.state.value&&(t.state.value="IDLE")},300)}handleWin(){this.gameLoop.stop();const t=e.getState(),s=t.currentLevel+1;t.unlockLevel(s),t.setHighScore(t.currentLevel,100*this.player.health.value),setTimeout(()=>{s<=5&&(t.setCurrentLevel(s),window.location.reload())},2e3)}handleLoss(){this.gameLoop.stop(),setTimeout(()=>{window.location.reload()},2e3)}}export{r as F,i as G,n as a,h as b,I as c,t as g};
